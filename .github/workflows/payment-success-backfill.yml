name: Backfill payment_success analytics

on:
  workflow_dispatch:
    inputs:
      days:
        description: "How many days to backfill (1-3650). Ignored if since/until provided."
        required: false
        default: "90"
      since:
        description: "Optional ISO date (YYYY-MM-DD) to start from (overrides days)."
        required: false
        default: ""
      until:
        description: "Optional ISO date (YYYY-MM-DD) to end at (overrides days)."
        required: false
        default: ""
      providers:
        description: "Comma-separated providers (stripe,paypal,conekta,admin)."
        required: false
        default: "stripe,paypal,conekta,admin"
      batch_size:
        description: "Batch size (50-5000)."
        required: false
        default: "250"
      limit:
        description: "Optional limit of events to ingest (blank = no limit)."
        required: false
        default: ""
      apply:
        description: "Set to true to write to DB (otherwise dry-run)."
        required: false
        default: "false"

concurrency:
  group: payment-success-backfill
  cancel-in-progress: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Backfill via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          command_timeout: 180m
          script: |
            set -e
            export PATH="/usr/local/bin:/usr/bin:$PATH"
            [ -f ~/.profile ] && . ~/.profile
            [ -f ~/.bashrc ] && . ~/.bashrc
            cd bear-beat

            # Keep scripts in sync with origin/main (same pattern as backend-deploy).
            git fetch origin main
            git reset --hard origin/main

            if [ -f ~/.nvm/nvm.sh ]; then
              . ~/.nvm/nvm.sh
              if [ -f backend/.nvmrc ]; then
                NODE_VERSION="$(tr -d ' \t\r\n' < backend/.nvmrc)"
                if [ -n "$NODE_VERSION" ]; then
                  nvm install "$NODE_VERSION"
                  nvm use "$NODE_VERSION"
                fi
              else
                nvm use default 2>/dev/null || true
              fi
            fi

            DAYS="${{ github.event.inputs.days }}"
            SINCE="${{ github.event.inputs.since }}"
            UNTIL="${{ github.event.inputs.until }}"
            PROVIDERS="${{ github.event.inputs.providers }}"
            BATCH_SIZE="${{ github.event.inputs.batch_size }}"
            LIMIT="${{ github.event.inputs.limit }}"
            APPLY="${{ github.event.inputs.apply }}"

            args=(--providers "$PROVIDERS" --batch-size "$BATCH_SIZE")

            if [ -n "$SINCE" ] || [ -n "$UNTIL" ]; then
              [ -n "$SINCE" ] && args+=(--since "$SINCE")
              [ -n "$UNTIL" ] && args+=(--until "$UNTIL")
            else
              args+=(--days "$DAYS")
            fi

            [ -n "$LIMIT" ] && args+=(--limit "$LIMIT")
            [ "$APPLY" = "true" ] && args+=(--apply)

            npm run analytics:payment-success:backfill --workspace=backend -- "${args[@]}"

