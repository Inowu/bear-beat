name: Backfill download history rollup

on:
  workflow_dispatch:
    inputs:
      days:
        description: "How many days to backfill (1-3650)"
        required: false
        default: "180"
      apply:
        description: "Set to true to write to DB (otherwise dry-run)"
        required: false
        default: "false"

concurrency:
  group: dh-rollup-backfill
  cancel-in-progress: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Backfill via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          command_timeout: 180m
          script: |
            set -e
            export PATH="/usr/local/bin:/usr/bin:$PATH"
            [ -f ~/.profile ] && . ~/.profile
            [ -f ~/.bashrc ] && . ~/.bashrc
            cd bear-beat

            # Keep scripts in sync with origin/main (same pattern as backend-deploy).
            git fetch origin main
            git reset --hard origin/main

            if [ -f ~/.nvm/nvm.sh ]; then
              . ~/.nvm/nvm.sh
              if [ -f backend/.nvmrc ]; then
                NODE_VERSION="$(tr -d ' \t\r\n' < backend/.nvmrc)"
                if [ -n "$NODE_VERSION" ]; then
                  nvm install "$NODE_VERSION"
                  nvm use "$NODE_VERSION"
                fi
              else
                nvm use default 2>/dev/null || true
              fi
            fi

            DAYS="${{ github.event.inputs.days }}"
            APPLY="${{ github.event.inputs.apply }}"

            if [ "$APPLY" = "true" ]; then
              npm run downloadHistory:rollup:backfill --workspace=backend -- --days "$DAYS" --apply
            else
              npm run downloadHistory:rollup:backfill --workspace=backend -- --days "$DAYS"
            fi

