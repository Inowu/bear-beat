name: Deploy backend

on:
  push:
    branches:
      - main
    paths:
      - backend/**
      - deploy.sh
      - .github/workflows/backend-deploy.yml
  workflow_dispatch:

concurrency:
  group: backend-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            # Diagnóstico (se ve en los logs si falla)
            echo "=== DIAG: HOME=$HOME ==="
            echo "=== DIAG: which npm ==="
            which npm || echo "npm no encontrado"
            echo "=== DIAG: PATH ==="
            echo "$PATH"
            echo "=== DIAG: nvm? ==="
            ls -la ~/.nvm 2>/dev/null || true
            ls -la /root/.nvm 2>/dev/null || true
            # Cargar nvm si existe (cualquier usuario)
            export PATH="/usr/local/bin:/usr/bin:$PATH"
            for nvm_sh in ~/.nvm/nvm.sh /root/.nvm/nvm.sh; do
              [ -f "$nvm_sh" ] && { . "$nvm_sh"; nvm use default 2>/dev/null || true; break; }
            done
            [ -f ~/.profile ] && . ~/.profile
            [ -f ~/.bashrc ] && . ~/.bashrc
            # Añadir rutas típicas de nvm/node por si no se cargó nvm.sh
            for d in ~/.nvm/versions/node/*/bin /root/.nvm/versions/node/*/bin; do
              [ -d "$d" ] && export PATH="$d:$PATH" && break
            done
            echo "=== DIAG después de cargar: which npm ==="
            which npm || echo "npm sigue sin encontrarse"
            cd bear-beat && bash ./deploy.sh
