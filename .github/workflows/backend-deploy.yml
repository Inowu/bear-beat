name: Deploy backend

on:
  push:
    branches:
      - main
    paths:
      - backend/**
      - deploy.sh
      - .github/workflows/backend-deploy.yml
  workflow_dispatch:

concurrency:
  group: backend-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            export PATH="/usr/local/bin:/usr/bin:$PATH"
            [ -f ~/.profile ] && . ~/.profile
            [ -f ~/.bashrc ] && . ~/.bashrc
            cd bear-beat
            # Ensure deploy.sh (and backend/.nvmrc) are up-to-date before executing.
            git fetch origin main
            git reset --hard origin/main
            if [ -f ~/.nvm/nvm.sh ]; then
              . ~/.nvm/nvm.sh
              if [ -f backend/.nvmrc ]; then
                NODE_VERSION="$(tr -d ' \t\r\n' < backend/.nvmrc)"
                if [ -n "$NODE_VERSION" ]; then
                  nvm install "$NODE_VERSION"
                  nvm use "$NODE_VERSION"
                fi
              else
                nvm use default 2>/dev/null || true
              fi
            fi
            # Optional: inject Stripe OXXO separate-account secrets into backend/.env (deploy.sh upserts).
            export DEPLOY_STRIPE_OXXO_KEY="${{ secrets.STRIPE_OXXO_KEY }}"
            export DEPLOY_STRIPE_OXXO_WH_PI_SECRET="${{ secrets.STRIPE_OXXO_WH_PI_SECRET }}"
            # Optional: inject AWS SES credentials into backend/.env (deploy.sh upserts).
            export DEPLOY_AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
            export DEPLOY_AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            export DEPLOY_SES_CONFIGURATION_SET="${{ secrets.SES_CONFIGURATION_SET }}"
            # Optional: inject Spotify credentials into backend/.env (deploy.sh upserts).
            export DEPLOY_SPOTIFY_CLIENT_ID="${{ secrets.SPOTIFY_CLIENT_ID }}"
            export DEPLOY_SPOTIFY_CLIENT_SECRET="${{ secrets.SPOTIFY_CLIENT_SECRET }}"
            export DEPLOY_SPOTIFY_MARKET="${{ secrets.SPOTIFY_MARKET }}"
            export DEPLOY_TRACK_METADATA_SPOTIFY_TEXT_MIN_CONFIDENCE="${{ secrets.TRACK_METADATA_SPOTIFY_TEXT_MIN_CONFIDENCE }}"
            bash ./deploy.sh
