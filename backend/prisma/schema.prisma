generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Config {
  id    Int    @id @default(autoincrement())
  name  String @db.Text
  value String @db.Text

  @@map("config")
}

model Countries {
  id   Int    @id @default(autoincrement()) @db.UnsignedSmallInt
  name String @unique(map: "name") @db.VarChar(255)
  code String @db.VarChar(10)

  @@map("countries")
}

model Cupons {
  id              Int     @id @default(autoincrement())
  code            String  @unique(map: "code") @db.VarChar(15)
  discount        Int
  type            Int
  cupon_condition String? @db.VarChar(10)
  parameter       Int?
  description     String? @db.Text
  active          Int     @default(1)

  @@map("cupons")
}

model CuponsUsed {
  id         Int      @id @default(autoincrement())
  user_id    Int
  cupon_id   Int
  date_cupon DateTime @db.DateTime(0)

  @@map("cupons_used")
}

model DescargasUser {
  id        Int      @id @default(autoincrement())
  user_id   Int
  order_id  Int?
  available Float    @db.Float
  ilimitado Int      @default(0)
  date_end  DateTime @db.Date

  @@map("descargas_user")
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model FtpGroup {
  groupname String @db.VarChar(16)
  gid       Int    @default(5500) @db.SmallInt
  members   String @db.VarChar(16)
  id        Int    @id @default(autoincrement())

  @@index([groupname], map: "groupname")
  @@map("ftpgroup")
}

model FtpQuotaLimits {
  id               Int                        @id @default(autoincrement())
  name             String?                    @db.VarChar(30)
  quota_type       ftpquotalimits_quota_type  @default(user)
  per_session      ftpquotalimits_per_session @default(false)
  limit_type       ftpquotalimits_limit_type  @default(soft)
  bytes_in_avail   BigInt                     @default(0) @db.UnsignedBigInt
  bytes_out_avail  BigInt                     @default(0) @db.UnsignedBigInt
  bytes_xfer_avail BigInt                     @default(0) @db.UnsignedBigInt
  files_in_avail   Int                        @default(0) @db.UnsignedInt
  files_out_avail  Int                        @default(0) @db.UnsignedInt
  files_xfer_avail Int                        @default(0) @db.UnsignedInt

  @@map("ftpquotalimits")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model FtpUser {
  id         Int       @id @default(autoincrement()) @db.UnsignedInt
  userid     String    @unique(map: "userid") @default("") @db.VarChar(32)
  passwd     String    @default("") @db.VarChar(32)
  uid        Int       @default(5500) @db.SmallInt
  gid        Int       @default(5500) @db.SmallInt
  homedir    String    @default("") @db.VarChar(255)
  shell      String    @default("/sbin/nologin") @db.VarChar(16)
  count      Int       @default(0)
  accessed   DateTime  @default(dbgenerated("'1999-01-01 00:00:00'")) @db.DateTime(0)
  modified   DateTime  @default(dbgenerated("'1999-01-01 00:00:00'")) @db.DateTime(0)
  user_id    Int?
  order_id   Int?
  expiration DateTime? @db.Date

  @@map("ftpuser")
}

model LoginHistory {
  id        Int     @id @default(autoincrement()) @db.UnsignedInt
  user      String  @db.VarChar(50)
  client_ip String  @db.VarChar(100)
  server_ip String  @db.VarChar(100)
  protocol  String  @db.Text
  when      String? @db.VarChar(150)

  @@map("login_history")
}

model Orders {
  id             Int      @id @default(autoincrement())
  date_order     DateTime @db.DateTime(0)
  payment_id     Int?
  user_id        Int
  total_price    Float    @db.Float
  status         Int      @default(0)
  discount       Int      @default(0)
  total_discount Float?   @db.Float
  cupon_id       Int?
  is_plan        Int      @default(0)
  plan_id        Int?
  txn_id         String?  @db.VarChar(100)
  payment_method String?  @db.Text
  invoice_id     String?  @db.Text
  is_canceled    Int?     @default(0)

  @@map("orders")
}

model SubscriptionCancellationFeedback {
  id             Int      @id @default(autoincrement())
  user_id        Int
  order_id       Int?
  payment_method String?  @db.VarChar(50)
  reason_code    String   @db.VarChar(60)
  reason_text    String?  @db.VarChar(500)
  utm_source     String?  @db.VarChar(120)
  utm_medium     String?  @db.VarChar(120)
  utm_campaign   String?  @db.VarChar(180)
  gclid          String?  @db.VarChar(255)
  fbclid         String?  @db.VarChar(255)
  created_at     DateTime @default(now()) @db.DateTime(0)

  @@index([user_id], map: "idx_scf_user_id")
  @@index([order_id], map: "idx_scf_order_id")
  @@index([reason_code], map: "idx_scf_reason_code")
  @@index([created_at], map: "idx_scf_created_at")
  @@map("subscription_cancellation_feedback")
}

model BillingConsent {
  id              Int      @id @default(autoincrement())
  user_id         Int
  order_id        Int?
  plan_id         Int
  provider        String   @db.VarChar(20)
  provider_ref    String?  @db.VarChar(120)
  consent_type    String   @db.VarChar(40)
  consent_version String   @db.VarChar(32)
  consent_text    String   @db.Text
  accepted        Boolean  @default(true)
  ip_address      String?  @db.VarChar(120)
  user_agent      String?  @db.Text
  page_url        String?  @db.VarChar(1000)
  created_at      DateTime @default(now()) @db.DateTime(0)

  @@index([user_id], map: "idx_billing_consents_user_id")
  @@index([order_id], map: "idx_billing_consents_order_id")
  @@index([provider, provider_ref], map: "idx_billing_consents_provider_ref")
  @@index([plan_id], map: "idx_billing_consents_plan_id")
  @@map("billing_consents")
}

model AutomationRunLog {
  id          Int      @id @default(autoincrement())
  started_at  DateTime @default(now()) @db.DateTime(0)
  finished_at DateTime? @db.DateTime(0)
  status      String   @db.VarChar(20)
  error       String?  @db.Text

  @@index([started_at], map: "idx_automation_runs_started_at")
  @@index([status], map: "idx_automation_runs_status")
  @@map("automation_run_logs")
}

model AutomationActionLog {
  id                  Int      @id @default(autoincrement())
  user_id             Int
  action_key          String   @db.VarChar(80)
  context_key         String   @default("") @db.VarChar(160)
  stage               Int      @default(0)
  channel             String   @db.VarChar(20)
  delivery_status     String?  @db.VarChar(32)
  provider_message_id String?  @db.VarChar(120)
  sent_at             DateTime @default(now()) @db.DateTime(0)
  metadata_json       Json?

  @@unique([user_id, action_key, stage, context_key], map: "uniq_automation_action_user_key_stage_context")
  @@index([user_id], map: "idx_automation_action_user_id")
  @@index([sent_at], map: "idx_automation_action_sent_at")
  @@index([context_key], map: "idx_automation_action_context_key")
  @@map("automation_action_logs")
}

model EmailDeliveryEvent {
  id                  Int      @id @default(autoincrement())
  provider            String   @default("ses") @db.VarChar(20)
  provider_event_id   String   @db.VarChar(120)
  provider_message_id String   @db.VarChar(120)
  event_type          String   @db.VarChar(32)
  event_ts            DateTime @db.DateTime(3)
  template_key        String?  @db.VarChar(120)
  action_key          String?  @db.VarChar(80)
  stage               Int?
  metadata_json       Json?
  created_at          DateTime @default(now()) @db.DateTime(0)

  @@unique([provider, provider_event_id], map: "uniq_email_delivery_events_provider_event")
  @@index([provider_message_id], map: "idx_email_delivery_events_provider_message_id")
  @@index([event_ts], map: "idx_email_delivery_events_event_ts")
  @@index([template_key], map: "idx_email_delivery_events_template_key")
  @@index([event_type], map: "idx_email_delivery_events_event_type")
  @@map("email_delivery_events")
}

model EmailTemplateOverride {
  id                 Int      @id @default(autoincrement())
  template_key       String   @unique(map: "uniq_email_template_overrides_template_key") @db.VarChar(120)
  enabled            Boolean  @default(true)
  subject            String?  @db.VarChar(191)
  html               String?  @db.LongText
  text               String?  @db.LongText
  updated_by_user_id Int?
  created_at         DateTime @default(now()) @db.DateTime(0)
  updated_at         DateTime @updatedAt @db.DateTime(0)

  @@index([enabled], map: "idx_email_template_overrides_enabled")
  @@index([updated_at], map: "idx_email_template_overrides_updated_at")
  @@map("email_template_overrides")
}

model AdminAuditLog {
  id             Int      @id @default(autoincrement())
  created_at     DateTime @default(now()) @db.DateTime(0)
  actor_user_id  Int
  action         String   @db.VarChar(80)
  target_user_id Int?
  metadata_json  Json?
  ip             String?  @db.VarChar(120)
  user_agent     String?  @db.VarChar(500)

  @@index([created_at], map: "idx_admin_audit_created_at")
  @@index([action], map: "idx_admin_audit_action")
  @@index([actor_user_id], map: "idx_admin_audit_actor_user_id")
  @@index([target_user_id], map: "idx_admin_audit_target_user_id")
  @@map("admin_audit_logs")
}

model AdSpendMonthly {
  id        Int      @id @default(autoincrement())
  month_key String   @db.VarChar(7)
  channel   String   @db.VarChar(80)
  currency  String   @default("MXN") @db.VarChar(8)
  amount    Decimal  @default(0) @db.Decimal(12, 2)
  created_at DateTime @default(now()) @db.DateTime(0)
  updated_at DateTime @updatedAt @db.DateTime(0)

  @@unique([month_key, channel, currency], map: "uniq_ad_spend_monthly_month_channel_currency")
  @@index([month_key], map: "idx_ad_spend_monthly_month_key")
  @@map("ad_spend_monthly")
}

model WebhookInboxEvent {
  id                   Int       @id @default(autoincrement())
  provider             String    @db.VarChar(32)
  event_id             String    @db.VarChar(191)
  event_type           String    @db.VarChar(120)
  livemode             Boolean?
  received_at          DateTime  @default(now()) @db.DateTime(0)
  updated_at           DateTime  @updatedAt @db.DateTime(0)
  status               String    @default("RECEIVED") @db.VarChar(20)
  attempts             Int       @default(0)
  next_retry_at        DateTime? @db.DateTime(0)
  processed_at         DateTime? @db.DateTime(0)
  last_error           String?   @db.LongText
  headers_json         Json?
  payload_raw          String    @db.LongText
  payload_hash         String?   @db.Char(64)
  processing_started_at DateTime? @db.DateTime(0)

  @@unique([provider, event_id], map: "uniq_webhook_inbox_provider_event")
  @@index([status, next_retry_at], map: "idx_webhook_inbox_status_next_retry_at")
  @@index([received_at], map: "idx_webhook_inbox_received_at")
  @@index([provider, event_type], map: "idx_webhook_inbox_provider_event_type")
  @@map("webhook_inbox_events")
}

model UserOffer {
  id            Int      @id @default(autoincrement())
  user_id       Int
  offer_key     String   @db.VarChar(80)
  stage         Int      @default(0)
  percent_off   Int
  coupon_code   String?  @db.VarChar(15)
  expires_at    DateTime @db.DateTime(0)
  created_at    DateTime @default(now()) @db.DateTime(0)
  redeemed_at   DateTime? @db.DateTime(0)
  metadata_json Json?

  @@unique([user_id, offer_key, stage], map: "uniq_user_offer_user_key_stage")
  @@index([expires_at], map: "idx_user_offer_expires_at")
  @@index([user_id], map: "idx_user_offer_user_id")
  @@map("user_offers")
}

model Plans {
  id                   Int     @id @default(autoincrement())
  name                 String  @db.VarChar(100)
  description          String  @db.Text
  moneda               String  @default("usd") @db.VarChar(200)
  homedir              String  @db.Text
  gigas                BigInt  @default(0)
  price                Decimal @db.Decimal(10, 2)
  duration             String  @db.VarChar(100)
  activated            Int     @default(0)
  tokens               Int?
  audio_ilimitado      Int?
  tokens_video         Int?
  video_ilimitado      Int?
  tokens_karaoke       Int?
  karaoke_ilimitado    Int?
  ilimitado_activo     Int?
  ilimitado_dias       Int?
  stripe_prod_id       String? @db.Text
  stripe_prod_id_test  String? @db.Text
  vip_activo           Int?
  conekta_plan_id      String? @db.Text
  conekta_plan_id_test String? @db.Text
  paypal_plan_id       String? @db.Text
  paypal_plan_id_test  String? @db.Text
  paypal_product_id    String? @db.Text

  @@map("plans")
}

model Roles {
  id   Int    @id @default(autoincrement())
  name String @unique(map: "name") @db.VarChar(255)

  @@map("roles")
}

model UserFiles {
  id             Int       @id @default(autoincrement())
  product_id     String    @db.VarChar(200)
  downloads_left Int
  order_id       Int
  user_id        Int
  since          DateTime? @db.Date

  @@map("user_files")
}

model Users {
  id                       Int                        @id @default(autoincrement())
  registered_on            DateTime                   @default(dbgenerated("'2018-01-01'")) @db.Date
  username                 String                     @unique(map: "username") @db.VarChar(255)
  password                 String                     @db.LongText
  first_name               String?                    @db.VarChar(255)
  last_name                String?                    @db.VarChar(255)
  address                  String?                    @db.VarChar(255)
  birthdate                DateTime?                  @db.Date
  email                    String                     @unique(map: "email") @db.VarChar(255)
  stripe_cusid             String?                    @db.VarChar(200)
  conekta_cusid            String?                    @db.VarChar(255)
  phone                    String?                    @db.VarChar(15)
  city                     String?                    @db.VarChar(100)
  role_id                  Int?                       @default(1)
  country_id               String?                    @db.VarChar(2)
  profile_img              String?                    @db.VarChar(100)
  active                   Int                        @default(0)
  activationcode           String?                    @db.Text
  mc_id                    Int?
  ip_registro              String?                    @db.Text
  token_expiration         DateTime?                  @db.DateTime(0)
  refresh_token            String?                    @db.VarChar(250)
  /// Marketing consent: email is opt-in by default; WhatsApp/SMS require explicit opt-in.
  email_marketing_opt_in   Boolean                    @default(true)
  /// Marketing categories (email): granular opt-out controls.
  /// `email_marketing_opt_in` remains as a legacy/global switch and should stay in sync
  /// with these category flags (see comms preferences + unsubscribe endpoint).
  email_marketing_news_opt_in   Boolean               @default(true)
  email_marketing_offers_opt_in Boolean               @default(true)
  email_marketing_digest_opt_in Boolean               @default(true)
  whatsapp_marketing_opt_in Boolean                   @default(false)
  sms_marketing_opt_in     Boolean                    @default(false)
  marketing_opt_in_updated_at DateTime?               @db.DateTime(0)
  /// One-time marketing trial guard (set when a trial subscription starts).
  trial_used_at            DateTime?                  @db.DateTime(0)
  blocked                  Boolean                    @default(false)
  verified                 Boolean                    @default(true)
  jobs                     jobs[]
  dir_downloads            dir_downloads[]
  product_orders           product_orders[]
  checkout_logs            checkout_logs[]
  change_plan_transactions change_plan_transactions[]
  DownloadHistory          DownloadHistory[]
  manyChatHandoffTokens    ManyChatHandoffToken[]     @relation("ManyChatHandoffClaimedUser")

  @@map("users")
}

model Ftpquotatallies {
  name            String                     @default("") @db.VarChar(30)
  quota_type      ftpquotatallies_quota_type @default(user)
  bytes_in_used   BigInt                     @default(0) @db.UnsignedBigInt
  bytes_out_used  BigInt                     @default(0) @db.UnsignedBigInt
  bytes_xfer_used BigInt                     @default(0) @db.UnsignedBigInt
  files_in_used   Int                        @default(0) @db.UnsignedInt
  files_out_used  Int                        @default(0) @db.UnsignedInt
  files_xfer_used Int                        @default(0) @db.UnsignedInt
  id              Int                        @id @default(autoincrement())
  last_renewed_at DateTime                   @default(now())

  @@map("ftpquotatallies")
}

model FtpQuotaTalliesHistory {
  id              Int                                @id @default(autoincrement())
  name            String                             @db.VarChar(30)
  quota_type      ftpquotatallies_history_quota_type @default(user)
  bytes_in_used   BigInt                             @default(0) @db.UnsignedBigInt
  bytes_out_used  BigInt                             @default(0) @db.UnsignedBigInt
  bytes_xfer_used BigInt                             @default(0) @db.UnsignedBigInt
  files_in_used   Int                                @default(0) @db.UnsignedInt
  files_out_used  Int                                @default(0) @db.UnsignedInt
  files_xfer_used Int                                @default(0) @db.UnsignedInt

  @@map("ftpquotatallies_history")
}

model product_orders {
  id             Int       @id @default(autoincrement())
  service        String    @db.VarChar(100)
  product_id     Int
  created_at     DateTime? @db.DateTime(0)
  status         Int
  user_id        Int
  payment_method String?   @default("Stripe") @db.VarChar(250)
  txn_id         String?   @default("") @db.VarChar(100)
  products       products  @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_products")
  users          Users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user")

  @@index([product_id], map: "FK_products")
  @@index([user_id], map: "fk_user")
}

model products {
  id                     Int              @id @default(autoincrement())
  name                   String           @db.VarChar(250)
  stripe_product_test_id String           @db.VarChar(50)
  stripe_product_id      String           @db.VarChar(50)
  amount                 Float            @db.Float
  price                  Float?           @default(350) @db.Float
  moneda                 String?          @default("MXN") @db.VarChar(10)
  product_orders         product_orders[]
}

model dir_downloads {
  id             Int       @id @default(autoincrement())
  userId         Int?
  size           BigInt?
  date           DateTime? @db.DateTime(0)
  dirName        String    @db.VarChar(500)
  // This is the id of the db job entity
  jobId          Int?
  downloadUrl    String?   @db.VarChar(1000)
  users          Users?    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "dir_downloads_ibfk_1")
  expirationDate DateTime? @db.DateTime(0)
}

model DownloadHistory {
  id       Int      @id @default(autoincrement())
  userId   Int
  size     BigInt
  date     DateTime @db.DateTime(0)
  fileName String   @db.VarChar(500)
  isFolder Boolean
  users    Users    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "download_history_ibfk_1")

  // Scale: speed up "history by user" and "public top downloads (sinceDays)" queries.
  @@index([userId, date], map: "idx_download_history_user_date")
  @@index([isFolder, date], map: "idx_download_history_isfolder_date")
  @@index([userId, isFolder, fileName], map: "idx_download_history_user_folder_file")
  @@map("download_history")
}

model DownloadHistoryArchive {
  id         BigInt   @default(autoincrement()) @db.UnsignedBigInt
  date       DateTime @db.DateTime(0)
  sourceId   Int
  userId     Int
  size       BigInt
  fileName   String   @db.VarChar(500)
  isFolder   Boolean
  archivedAt DateTime @default(now()) @db.DateTime(0)

  @@id([id, date])
  @@unique([sourceId, date], map: "uniq_dha_source_date")
  @@index([date], map: "idx_dha_date")
  @@index([sourceId], map: "idx_dha_source_id")
  @@index([archivedAt], map: "idx_dha_archived_at")
  @@index([userId, date], map: "idx_dha_user_date")
  @@index([isFolder, date], map: "idx_dha_isfolder_date")
  @@map("download_history_archive")
}

model DownloadHistoryRollupDaily {
  // Category for public "Top Downloads" (audio/video/karaoke). Stored as string for easy raw SQL/backfills.
  category   String   @db.VarChar(16)
  // Daily bucket. Use UTC day boundaries in app/scripts for stable rollups.
  day        DateTime @db.Date
  fileName   String   @db.VarChar(500)
  downloads  BigInt   @default(0) @db.UnsignedBigInt
  totalBytes BigInt   @default(0) @db.UnsignedBigInt
  lastDownload DateTime @db.DateTime(0)

  @@id([category, day, fileName])
  @@index([day], map: "idx_dh_rollup_day")
  @@map("download_history_rollup_daily")
}

model TrackMetadata {
  id              Int      @id @default(autoincrement())
  path            String   @unique(map: "uniq_track_metadata_path") @db.VarChar(700)
  name            String   @db.VarChar(500)
  artist          String?  @db.VarChar(255)
  title           String?  @db.VarChar(500)
  displayName     String?  @map("display_name") @db.VarChar(600)
  bpm             Int?
  camelot         String?  @db.VarChar(4)
  energyLevel     Int?     @map("energy_level")
  format          String?  @db.VarChar(10)
  version         String?  @db.VarChar(80)
  coverUrl        String?  @map("cover_url") @db.VarChar(1000)
  durationSeconds Int?     @map("duration_seconds")
  source          String   @default("inferred") @db.VarChar(20)
  createdAt       DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)

  @@index([name], map: "idx_track_metadata_name")
  @@index([artist], map: "idx_track_metadata_artist")
  @@index([title], map: "idx_track_metadata_title")
  @@index([bpm], map: "idx_track_metadata_bpm")
  @@map("track_metadata")
}

model jobs {
  id         Int       @id @default(autoincrement())
  user_id    Int
  queue      String    @db.VarChar(255)
  status     String    @db.VarChar(50)
  createdAt  DateTime  @db.DateTime(0)
  // This is the id of the job in the queue
  jobId      String?   @db.VarChar(255)
  finishedAt DateTime? @db.DateTime(0)
  users      Users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "jobs_ibfk_1")
}

model checkout_logs {
  id                 Int      @id @default(autoincrement())
  user_id            Int
  last_checkout_date DateTime @db.DateTime(0)
  users              Users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "checkout_logs_ibfk_1")

  @@index([user_id], map: "user_id")
}

model ManyChatHandoffToken {
  id             Int       @id @default(autoincrement())
  token          String    @unique(map: "uniq_mch_token") @db.VarChar(80)
  contact_id     String?   @db.VarChar(64)
  channel        String?   @db.VarChar(24)
  payload_json   Json?
  created_at     DateTime  @default(now()) @db.DateTime(0)
  expires_at     DateTime  @db.DateTime(0)
  resolved_at    DateTime? @db.DateTime(0)
  claimed_at     DateTime? @db.DateTime(0)
  claimed_user_id Int?
  claimed_user   Users?    @relation("ManyChatHandoffClaimedUser", fields: [claimed_user_id], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "manychat_handoff_tokens_ibfk_1")

  @@index([created_at], map: "idx_mch_created_at")
  @@index([claimed_user_id], map: "idx_mch_claimed_user_id")
  @@map("manychat_handoff_tokens")
}

model DeletedUsers {
  id           Int      @id @default(autoincrement())
  email        String   @db.VarChar(255)
  deletionDate DateTime @db.DateTime(0)
  reactivated  Boolean  @default(false)

  @@map("deleted_users")
}

model change_plan_transactions {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      Users    @relation(fields: [id], references: [id], onDelete: Cascade)
  newPlanId Int
  oldPlanId Int
  createdAt DateTime @db.DateTime(0)
}

enum ftpquotalimits_quota_type {
  user
  group
  class
  all
}

enum ftpquotalimits_per_session {
  false
  true
}

enum ftpquotalimits_limit_type {
  soft
  hard
}

enum ftpquotatallies_quota_type {
  user
  group
  class
  all
}

enum ftpquotatallies_history_quota_type {
  user
  group
  class
  all
}
